---
import { getEntry } from 'astro:content'
import slugify from 'slugify'
import { render } from 'astro:content'

interface Props {
  postId: string
  card?: boolean
}

const { postId, card } = Astro.props

const post = await getEntry('posts', postId)
if (post === undefined) {
  throw new Error(`${postId} does not refer to an existing post`)
}

const { remarkPluginFrontmatter: fm, Content } = await render(post)
const { tags } = post.data
---

<article class="post" transition:name={`post.${postId}`} transition:animate="initial" data-pagefind-body>
  <hgroup>
    {
      card ? (
        <h3>
          <a href={`/posts/${postId}`}>{fm.title}</a>
        </h3>
      ) : (
        <h1 data-pagefind-meta="title">{fm.title}</h1>
      )
    }

    {fm.tagline && <p>{fm.tagline}</p>}

    <small>
      {
        (tags.length > 0 || fm.series) && (
          <ul data-pagefind-meta={tags.length > 0 ? `tags:${tags.join(', ')}` : null}>
            {fm.series && (
              <li
                data-pagefind-filter={`series:${slugify(fm.series, { lower: true })}`}
                data-pagefind-meta={`series:${fm.series}`}
              >
                <a href={`/posts?series=${slugify(fm.series, { lower: true })}`}>{fm.series}</a>
              </li>
            )}

            {tags.length > 0 &&
              (tags as string[]).map((tag) => (
                <li data-pagefind-filter={`tag:${tag}`}>
                  <a href={`/posts?tag=${tag}`}>{'#' + tag}</a>
                </li>
              ))}
          </ul>
        )
      }
      <span data-pagefind-meta="published" data-pagefind-sort="published">{fm.published}</span>
      {' - '}
      <span data-pagefind-meta="reading time">{fm.readingTime}</span>
      {' - '}
      <span data-pagefind-meta="word count" data-pagefind-sort="word count">{fm.wordCount} words</span>
    </small>
  </hgroup>
  <hr />

  <prose>{card ? <p>{fm.brief}</p> : <Content />}</prose>
</article>

<style>
  article.post {
    margin: 0;

    hgroup {
      margin-inline: 1rem;
      margin-block: 0;
    }

    ul {
      display: flex;
      flex-wrap: wrap;
      column-gap: 0.25rem;
      list-style: none;
      padding: 0;
      margin-block: 0;
    }

    hr {
      margin-block: 0.5rem;
      margin-inline: 1rem;
    }
  }
</style>
