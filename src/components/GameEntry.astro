---
import { Image } from 'astro:assets'
import type { ImageMetadata } from 'astro'
import { parseHTML } from 'linkedom'

interface Props {
  cover?: ImageMetadata
  number?: number
  awards?: (string | [string, number?, number?])[]
  link?: string
}

const { cover, number, link } = Astro.props

const { document } = parseHTML(await Astro.slots.render('default'))

const firstHeading = document.querySelector('h1, h2, h3, h4, h5, h6')
const title = firstHeading?.textContent

const awards = Astro.props.awards?.map((a) => {
  if (!Array.isArray(a)) {
    return {
      text: a,
      fontSize: 32,
      displacement: 0,
    }
  }

  const [text, fontSize, displacement] = a

  return {
    text,
    fontSize: (fontSize ?? 1) * 32,
    displacement: displacement ?? 0,
  }
})
---

<style>
  .game-entry {
    display: flow-root;
    & > :global(*):last-child {
      margin-block-end: 0;
    }

    h2,
    h3,
    h4,
    h5,
    h6 {
      margin-block-start: 0;
    }
  }

  .cover {
    float: inline-end;
    position: relative;
    max-width: max(8rem, 39%);
    width: 20rem;
    margin-inline-start: 0.5rem;
    margin-block-end: 0.5rem;
    box-shadow: 0.1rem 0.1rem 0.4rem rgb(from black r g b / 50%);
    z-index: 100;
    overflow: hidden;
    transition-duration: 0.2s;
    transition-property: transform box-shadow;
    transition-timing-function: ease-in-out;

    & > img {
      display: block;
    }

    & > .backloggd-link {
      display: block;
      position: absolute;
      bottom: -5px;
      width: 100%;
      font-size: 85%;
      text-align: center;
      background-color: var(--color-mantle);
      padding-bottom: 0.5rem;
      padding-top: 0.2rem;
      transform: translateY(100%);

      transition-property: transform;
      transition-duration: 0.2s;
      transition-timing-function: ease-in-out;
    }

    &:hover {
      transform: scale(105%);
      box-shadow: 0.1rem 0.1rem 0.5rem rgb(from black r g b / 50%);

      .backloggd-link {
        transform: translateY(0%);
      }
    }
  }

  .awards {
    float: inline-end;
    max-width: max(8rem, 39%);
    clear: both;
    margin-block-start: -0.5rem;
    margin-block-end: 0.25rem;
    margin-inline: clamp(0rem, (min(20rem, 39%) - (12rem)) / 2, 1rem);
    > * {
      float: inline-end;
    }
  }

  .award {
    position: relative;
    color: black;
    text-align: center;
    width: 4rem;
    filter: drop-shadow(0.1rem 0.1rem 0.2rem rgb(from black r g b / 50%));
    text-transform: uppercase;
    transform-origin: top;
    transition-duration: 0.2s;
    transition-property: transform filter;

    &:hover {
      transform: scale(110%);
      /* This !important will be easier to get rid of once Firefox supports sibling-index() */
      z-index: 50 !important;
      filter: drop-shadow(0.1rem 0.1rem 0.3rem rgb(from black r g b / 50%));
    }
  }

  .award-label {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 110px;
  }

  .number {
    float: left;
    font-size: 500%;
    font-weight: 200;
    line-height: 0.8;
    display: block;
    margin-inline-end: 0.5rem;
    margin-inline-start: -0.5rem;
    margin-block-end: 0.5rem;
    color: var(--color-base);
    -webkit-text-stroke: 2px var(--color-lavender);
  }

  @media screen and (max-width: 60ch) {
    .number {
      background-color: transparent;
      width: calc(100% - (max(8rem, 39%) + 0.5rem));
      margin-inline: 0;
    }
  }
</style>

<div class="game-entry">
  {number && <span class="number">{number}</span>}

  {
    cover && (
      <div class="cover">
        <Image src={cover} alt={`Cover for ${title}`} />
        {link && (
          <div class="backloggd-link">
            <a href={link} rel="external" target="_blank" set:text="View on Backloggd" />
          </div>
        )}
      </div>
    )
  }

  {
    awards && (
      <div class="awards">
        {awards.map((a, index) => (
          <svg class="award" viewBox="50 0 200 400" style={`z-index: ${awards.length - index};`}>
            {/* Ribbon */}
            <polygon points="160,0 210,0 180,160 130,160" fill="oklch(from var(--color-red) calc(l - 0.1) c h)" />
            <polygon points="90,0 140,0 170,160 120,160" fill="var(--color-red)" />

            {/* Ribbon folds */}
            <polygon points="130,160 150,220 180,160" fill="oklch(from var(--color-red) calc(l - 0.12) c h)" />
            <polygon points="120,160 150,220 170,160" fill="oklch(from var(--color-red) calc(l - 0.02) c h)" />

            {/* Medal */}
            <circle cx="150" cy="300" r="95" fill="var(--color-yellow)" />

            <foreignObject x="60" y={240 + a.displacement} width="180" height="120">
              <div class="award-label" style={`font-size: ${a.fontSize}px;`}>
                {a.text}
              </div>
            </foreignObject>
          </svg>
        ))}
      </div>
    )
  }

  <Fragment set:html={document} />
</div>
